# DB-008: Test DbValue.release() on borrowed values is safe no-op

## Overview

Add explicit tests documenting the safety contract that `DbValue.borrowed()` values (which have `release_fn=null`) can be safely released without panicking. While `release()` already null-checks before calling, no test explicitly asserts this invariant. This is a regression-prevention test — if someone removes the null check in a future refactor, this test catches it immediately.

## Step-by-step Implementation

### Step 1: Add `DbValue.borrowed().release()` safety test

**File**: `client/db/adapter.zig` (append after line 2610)

```zig
test "DbValue: release on borrowed value is safe no-op" {
    const val = DbValue.borrowed("hello");
    val.release(); // must not panic — release_fn is null
    // Verify bytes remain accessible and uncorrupted after release
    try std.testing.expectEqualStrings("hello", val.bytes);
}
```

**Rationale**: This is the core contract test. It verifies:
1. `release()` does not panic when `release_fn` is null
2. `bytes` remain valid after release (no corruption, no zeroing)

### Step 2: Add `DbEntry.release()` on borrowed entries safety test

**File**: `client/db/adapter.zig` (append after Step 1's test)

```zig
test "DbEntry: release on borrowed entry is safe no-op" {
    const entry = DbEntry{
        .key = DbValue.borrowed("key"),
        .value = DbValue.borrowed("value"),
    };
    entry.release(); // must not panic — both release_fn are null
    try std.testing.expectEqualStrings("key", entry.key.bytes);
    try std.testing.expectEqualStrings("value", entry.value.bytes);
}
```

**Rationale**: `DbEntry.release()` delegates to `DbValue.release()` for both key and value. This test ensures the delegation chain is safe for fully-borrowed entries.

## Files to Modify

| File | Change |
|------|--------|
| `client/db/adapter.zig` | Append 2 tests after line 2610 |

## Files to Create

None.

## Tests to Write

| Test Name | Purpose |
|-----------|---------|
| `DbValue: release on borrowed value is safe no-op` | Core contract: borrowed values have null release_fn, release() is safe |
| `DbEntry: release on borrowed entry is safe no-op` | Delegation chain: borrowed entries delegate release to borrowed values safely |

## How to Run

```bash
cd /Users/williamcory/xvi && zig test client/db/adapter.zig
```

Or with the build system if available:
```bash
zig build test
```

## Risks and Mitigations

| Risk | Likelihood | Mitigation |
|------|------------|------------|
| Test is trivially simple and adds no real value | Low | The value is in *documenting* the contract, not in the test's complexity. Future refactors that break the null check will fail here. |
| Build system issues (wallycore dependency) | Medium | Run tests directly with `zig test client/db/adapter.zig` to bypass build system issues |
| Tests pass but don't detect regression | Very Low | The test directly exercises the exact code path (null release_fn → no-op). Removing the null check would cause a null pointer dereference, which Zig detects as a panic. |

## Verification Against Acceptance Criteria

- **"Add a test: `const val = DbValue.borrowed("hello"); val.release();`"** → Step 1 does exactly this
- **"Should not panic"** → If release() panics, the test fails
- **"Documents the contract"** → Test name and comment explicitly state the contract
- **"Catches regressions"** → Removing the null check in `release()` would cause null-pointer dereference → panic → test failure

## Estimated Effort

~5 minutes. Two small test blocks, no new types or functions.
