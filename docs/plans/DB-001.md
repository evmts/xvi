# DB-001: NullDb.put_impl should silently discard writes, not return StorageError

## Status: PLAN — Awaiting Approval

## Overview

`NullDb.put_impl` and `NullDb.delete_impl` currently return `error.StorageError`, breaking code paths that use NullDb as a universal no-op (black hole) backend. The fix changes both functions to silently discard writes (return `void`), making NullDb a true null object for both reads AND writes.

**Design deviation from Nethermind:** Nethermind's `NullDb.cs` throws `NotSupportedException` on writes (lines 29-30, 38-39). This ticket intentionally deviates to make NullDb more useful in Zig. The existing `ReadOnlyDb` already provides the "writes return error" behavior for code that needs it.

**Scope:** Two files (`client/db/null.zig`, `guillotine-mini/client/db/null.zig`), three tests each, plus two doc comment updates. No Voltaire types involved. No Ethereum specs involved.

## Step-by-Step Implementation Order

### Step 1: Update `put_impl` in `client/db/null.zig`

- **File:** `client/db/null.zig`, line 79-82
- **Change:** Replace `return error.StorageError;` with `return;` (or just empty body `{}`)
- **Update comment:** Change "writes are not supported" → "silently discarded (null object pattern)"

**Before:**
```zig
fn put_impl(_: *NullDb, _: []const u8, _: ?[]const u8, _: WriteFlags) Error!void {
    // Null database: writes are not supported.
    return error.StorageError;
}
```

**After:**
```zig
fn put_impl(_: *NullDb, _: []const u8, _: ?[]const u8, _: WriteFlags) Error!void {
    // Null database: writes silently discarded (null object pattern).
}
```

### Step 2: Update `delete_impl` in `client/db/null.zig`

- **File:** `client/db/null.zig`, line 84-87
- **Change:** Replace `return error.StorageError;` with empty body
- **Update comment:** Change "deletes are not supported" → "deletes silently discarded (null object pattern)"

**Before:**
```zig
fn delete_impl(_: *NullDb, _: []const u8, _: WriteFlags) Error!void {
    // Null database: deletes are not supported.
    return error.StorageError;
}
```

**After:**
```zig
fn delete_impl(_: *NullDb, _: []const u8, _: WriteFlags) Error!void {
    // Null database: deletes silently discarded (null object pattern).
}
```

### Step 3: Update the 3 affected tests in `client/db/null.zig`

Tests change from `expectError` to verifying silent success.

**Test 1 — "NullDb: put returns StorageError"** (lines 183-189)
- Rename to: `"NullDb: put silently discards"`
- Change body from `expectError` to `try iface.put("key", "value");` (succeeds without error)
- Verify data was discarded: `try std.testing.expect((try iface.get("key")) == null);`

**Test 2 — "NullDb: put with null returns StorageError"** (lines 191-197)
- Rename to: `"NullDb: put with null silently discards"`
- Change body from `expectError` to `try iface.put("key", null);` (succeeds without error)

**Test 3 — "NullDb: delete returns StorageError"** (lines 199-205)
- Rename to: `"NullDb: delete silently discards"`
- Change body from `expectError` to `try iface.delete("key");` (succeeds without error)

### Step 4: Update module-level doc comment in `client/db/null.zig`

- **File:** `client/db/null.zig`, line 6
- **Change:** `"All write operations return \`error.StorageError\` (not supported)."` → `"All write operations silently discard data (null object pattern)."`

### Step 5: Update `root.zig` doc comment

- **File:** `client/db/root.zig`, line 78
- **Change:** `"Null object backend (reads return null, writes error)."` → `"Null object backend (reads return null, writes silently discard)."`

### Step 6: Update `guillotine-mini/client/db/null.zig` — `put_impl`

- **File:** `guillotine-mini/client/db/null.zig`, line 85-88
- **Same change as Step 1** but note the function signature uses `*anyopaque` instead of `*NullDb`

**Before:**
```zig
fn put_impl(_: *anyopaque, _: []const u8, _: ?[]const u8, _: WriteFlags) Error!void {
    // Null database: writes are not supported.
    return error.StorageError;
}
```

**After:**
```zig
fn put_impl(_: *anyopaque, _: []const u8, _: ?[]const u8, _: WriteFlags) Error!void {
    // Null database: writes silently discarded (null object pattern).
}
```

### Step 7: Update `guillotine-mini/client/db/null.zig` — `delete_impl`

- **File:** `guillotine-mini/client/db/null.zig`, line 90-93
- **Same change as Step 2** with `*anyopaque` signature

### Step 8: Update the 3 affected tests in `guillotine-mini/client/db/null.zig`

- **Same test renames and body changes as Step 3** (lines 185-205 in guillotine-mini copy)

### Step 9: Update module-level doc comment in `guillotine-mini/client/db/null.zig`

- **Same change as Step 4** (line 6 in guillotine-mini copy)

### Step 10: Run `zig fmt` on both files

```bash
zig fmt client/db/null.zig
zig fmt guillotine-mini/client/db/null.zig
```

### Step 11: Run `zig build` to verify compilation

```bash
zig build
```

### Step 12: Run tests to verify all pass

```bash
zig build test
```

Verify specifically that the NullDb tests all pass and no other tests regress.

## Files to Create

None — no new files needed.

## Files to Modify

| File | Changes |
|------|---------|
| `client/db/null.zig` | `put_impl` body, `delete_impl` body, 3 test renames + bodies, module doc comment |
| `client/db/root.zig` | Line 78 doc comment update |
| `guillotine-mini/client/db/null.zig` | `put_impl` body, `delete_impl` body, 3 test renames + bodies, module doc comment |

## Tests to Write

No new test files. Three existing tests per file are updated (6 total):

| Original Test Name | New Test Name | Verification |
|---------------------|--------------|--------------|
| `"NullDb: put returns StorageError"` | `"NullDb: put silently discards"` | `try iface.put(...)` succeeds, `iface.get(...)` returns null |
| `"NullDb: put with null returns StorageError"` | `"NullDb: put with null silently discards"` | `try iface.put(..., null)` succeeds |
| `"NullDb: delete returns StorageError"` | `"NullDb: delete silently discards"` | `try iface.delete(...)` succeeds |

## Risks and Mitigations

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Code that relies on NullDb write errors for correctness | Those code paths would silently succeed instead of erroring | LOW — `ReadOnlyDb` exists for "writes should error" pattern; NullDb is used as a universal no-op | Grep for `NullDb` usage across codebase to confirm no caller depends on write errors |
| guillotine-mini copy diverges further from client/ copy | Maintenance burden | LOW — Both copies follow identical logic, just different vtable wiring | Apply identical semantic changes to both |
| Future Nethermind alignment regression | If we later want to match Nethermind's throw-on-write behavior | LOW — Deliberate design choice documented in context file | Document the deviation in the code comments |

## Verification Against Acceptance Criteria

1. **`NullDb.put_impl` returns void** — Verified by updated tests calling `try iface.put(...)` without error
2. **`NullDb.delete_impl` returns void** — Verified by updated tests calling `try iface.delete(...)` without error
3. **Data is discarded (not stored)** — Verified by `put` test that checks `get` returns null after put
4. **All 3 affected tests updated** — Renamed and rewritten in both files (6 total)
5. **No regressions** — `zig build test` passes
6. **Both copies updated** — `client/db/null.zig` and `guillotine-mini/client/db/null.zig`
7. **Doc comments updated** — Module doc in both null.zig files + root.zig line 78

## Commit Strategy

Single atomic commit covering all changes:

```
♻️ refactor(db): NullDb silently discards writes instead of returning StorageError

NullDb now acts as a true null object for both reads AND writes.
put_impl and delete_impl return void instead of error.StorageError.
This makes NullDb usable as a universal no-op backend without
callers needing to handle write errors.

Intentional deviation from Nethermind's NullDb.cs which throws
NotSupportedException on writes. ReadOnlyDb provides the
"writes should error" behavior for code that needs it.

Updated 6 tests (3 per file) and doc comments in both
client/db/null.zig and guillotine-mini/client/db/null.zig.
```
