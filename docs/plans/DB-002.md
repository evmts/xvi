# DB-002: Refactor ReadOnlyDb.database() and RocksDatabase.database() to Use Database.init()

## Overview

Pure refactor: `ReadOnlyDb.database()` and `RocksDatabase.database()` currently construct the `Database` vtable via raw `ptr + vtable` struct literals with manual `@ptrCast/@alignCast` in every vtable implementation function. This is inconsistent with `MemoryDatabase.database()` and `NullDb.database()`, which already use the type-safe `Database.init()` comptime helper.

The refactor eliminates manual pointer casting, provides compile-time type safety, and achieves consistency across all four Database backends.

**No behavioral changes.** All 35 existing tests (25 ReadOnlyDb + 10 RocksDatabase) serve as regression tests.

## Step-by-Step Implementation

### Step 1: Refactor RocksDatabase vtable impl functions (rocksdb.zig)

**File:** `client/db/rocksdb.zig`

RocksDatabase is simpler (stub backend, most functions ignore `self`), so we start here to establish the pattern.

**Changes:**

1. **Remove the standalone `const vtable` declaration** (lines 123-135)
2. **Change all 11 vtable impl function signatures** from `*anyopaque` to `*RocksDatabase`:
   - `name_impl(ptr: *anyopaque)` → `name_impl(self: *RocksDatabase)`
   - `get_impl(_: *anyopaque, ...)` → `get_impl(_: *RocksDatabase, ...)`
   - `put_impl(_: *anyopaque, ...)` → `put_impl(_: *RocksDatabase, ...)`
   - `delete_impl(_: *anyopaque, ...)` → `delete_impl(_: *RocksDatabase, ...)`
   - `contains_impl(_: *anyopaque, ...)` → `contains_impl(_: *RocksDatabase, ...)`
   - `iterator_impl(_: *anyopaque, ...)` → `iterator_impl(_: *RocksDatabase, ...)`
   - `snapshot_impl(_: *anyopaque)` → `snapshot_impl(_: *RocksDatabase)`
   - `flush_impl(_: *anyopaque, ...)` → `flush_impl(_: *RocksDatabase, ...)`
   - `clear_impl(_: *anyopaque)` → `clear_impl(_: *RocksDatabase)`
   - `compact_impl(_: *anyopaque)` → `compact_impl(_: *RocksDatabase)`
   - `gather_metric_impl(_: *anyopaque)` → `gather_metric_impl(_: *RocksDatabase)`
3. **Remove the manual `@ptrCast(@alignCast(ptr))` line** in `name_impl` (the only function that used `self`)
4. **Refactor `database()` method** to use `Database.init()`:

```zig
pub fn database(self: *RocksDatabase) Database {
    return Database.init(RocksDatabase, self, .{
        .name = name_impl,
        .get = get_impl,
        .put = put_impl,
        .delete = delete_impl,
        .contains = contains_impl,
        .iterator = iterator_impl,
        .snapshot = snapshot_impl,
        .flush = flush_impl,
        .clear = clear_impl,
        .compact = compact_impl,
        .gather_metric = gather_metric_impl,
    });
}
```

**Verify:** Run all 10 RocksDatabase tests — all must pass unchanged.

### Step 2: Refactor ReadOnlyDb vtable impl functions (read_only.zig)

**File:** `client/db/read_only.zig`

ReadOnlyDb is more complex (overlay logic, iterators, snapshots), but the vtable refactor is identical in structure.

**Changes:**

1. **Remove the standalone `const vtable` declaration** (lines 297-309)
2. **Change all 11 vtable impl function signatures** from `*anyopaque` to `*ReadOnlyDb`:
   - `name_impl(ptr: *anyopaque)` → `name_impl(self: *ReadOnlyDb)`
   - `get_impl(ptr: *anyopaque, ...)` → `get_impl(self: *ReadOnlyDb, ...)`
   - `put_impl(ptr: *anyopaque, ...)` → `put_impl(self: *ReadOnlyDb, ...)`
   - `delete_impl(ptr: *anyopaque, ...)` → `delete_impl(self: *ReadOnlyDb, ...)`
   - `contains_impl(ptr: *anyopaque, ...)` → `contains_impl(self: *ReadOnlyDb, ...)`
   - `iterator_impl(ptr: *anyopaque, ...)` → `iterator_impl(self: *ReadOnlyDb, ...)`
   - `snapshot_impl(ptr: *anyopaque)` → `snapshot_impl(self: *ReadOnlyDb)`
   - `flush_impl(_: *anyopaque, ...)` → `flush_impl(_: *ReadOnlyDb, ...)`
   - `clear_impl(_: *anyopaque)` → `clear_impl(_: *ReadOnlyDb)`
   - `compact_impl(_: *anyopaque)` → `compact_impl(_: *ReadOnlyDb)`
   - `gather_metric_impl(ptr: *anyopaque)` → `gather_metric_impl(self: *ReadOnlyDb)`
3. **Remove all manual `const self: *ReadOnlyDb = @ptrCast(@alignCast(ptr));` lines** from each function body (8 functions use `self`: name, get, put, delete, contains, iterator, snapshot, gather_metric)
4. **Refactor `database()` method** to use `Database.init()`:

```zig
pub fn database(self: *ReadOnlyDb) Database {
    return Database.init(ReadOnlyDb, self, .{
        .name = name_impl,
        .get = get_impl,
        .put = put_impl,
        .delete = delete_impl,
        .contains = contains_impl,
        .iterator = iterator_impl,
        .snapshot = snapshot_impl,
        .flush = flush_impl,
        .clear = clear_impl,
        .compact = compact_impl,
        .gather_metric = gather_metric_impl,
    });
}
```

**Verify:** Run all 25 ReadOnlyDb tests — all must pass unchanged.

### Step 3: Run full DB test suite and format

1. Run `zig fmt client/db/rocksdb.zig client/db/read_only.zig`
2. Run full DB test suite to verify no regressions across all 165 tests (10 modules)
3. Run `zig build` to verify compilation

## Files to Modify

| File | Change |
|------|--------|
| `client/db/rocksdb.zig` | Refactor `database()` to use `Database.init()`, change 11 vtable impl fn signatures from `*anyopaque` to `*RocksDatabase`, remove manual vtable decl, remove manual `@ptrCast/@alignCast` |
| `client/db/read_only.zig` | Refactor `database()` to use `Database.init()`, change 11 vtable impl fn signatures from `*anyopaque` to `*ReadOnlyDb`, remove manual vtable decl, remove all manual `@ptrCast/@alignCast` lines |

## Files to Create

None.

## Files Read-Only (reference)

| File | Purpose |
|------|---------|
| `client/db/adapter.zig` | `Database.init()` helper definition (lines 516-612) |
| `client/db/memory.zig` | Reference: MemoryDatabase uses `Database.init()` and typed `*MemoryDatabase` params |
| `client/db/null.zig` | Reference: NullDb uses `Database.init()` and typed `*NullDb` params |

## Tests to Write

**No new tests needed.** This is a pure internal refactor — the existing 35 tests provide complete regression coverage:

| Test Suite | Count | Coverage |
|------------|-------|----------|
| RocksDatabase tests (rocksdb.zig) | 10 | get/put/delete/contains errors, name/path, multiple instances, DbSettings |
| ReadOnlyDb tests (read_only.zig) | 25 | Strict mode (get, put error, delete error, vtable dispatch), overlay mode (put/get, precedence, clear, delete, contains, reusable), iterators (merge, ordered unsupported), snapshots, wrapped-db safety, deinit/leak |

All existing tests exercise the `Database` vtable interface via `ro.database()` and `db.database()` — exactly the code path being refactored. If the `Database.init()` wiring is incorrect, these tests will catch it.

## Risks and Mitigations

### Risk 1: Function signature mismatch with Database.init() expectations
**Issue:** `Database.init()` expects functions with signature `fn(self: *T, ...) Error!ReturnType`. If any vtable impl function has a slightly different signature (e.g., missing `Error!` on the return type for `name_impl`), compilation will fail.
**Mitigation:** The reference implementations (MemoryDatabase, NullDb) already use exactly these signatures. Copy the pattern exactly. `name_impl` returns `DbName` (not `Error!DbName`) — this matches because `Database.init()` expects `*const fn (self: *T) DbName` for the `name` field.

### Risk 2: ReadOnlyDb functions that take but ignore self
**Issue:** `flush_impl`, `clear_impl`, `compact_impl` currently use `_: *anyopaque`. After refactoring, they must use `_: *ReadOnlyDb`. The `Database.init()` helper expects `*T` — using `_` to ignore the parameter is valid Zig.
**Mitigation:** NullDb already does this pattern (`_: *NullDb`). Verified that `Database.init()` passes the typed pointer regardless of whether the function uses it.

### Risk 3: No behavioral change but vtable pointer changes
**Issue:** After refactoring, the vtable pointer stored in the `Database` struct changes from `&ReadOnlyDb.vtable` (a module-level const) to `&Wrapper.vtable` (a comptime-generated const inside `Database.init()`). The pointer value differs, but both point to functionally identical vtable implementations.
**Mitigation:** No code compares vtable pointers for equality. All tests exercise behavior, not identity.

## Verification Against Acceptance Criteria

1. **ReadOnlyDb.database() uses Database.init()** — Refactored in Step 2 ✓
2. **RocksDatabase.database() uses Database.init()** — Refactored in Step 1 ✓
3. **Consistent with MemoryDatabase and NullDb** — All 4 backends now use same pattern ✓
4. **Compile-time type safety** — `Database.init()` checks function signatures at comptime ✓
5. **No manual @ptrCast/@alignCast** — Removed from all vtable impl functions ✓
6. **No standalone vtable const** — Removed from both files ✓
7. **All existing tests pass** — 35 tests (25 + 10) serve as regression suite ✓
8. **No behavioral changes** — Pure internal refactor, external interface unchanged ✓
9. **zig fmt clean** — Formatted after changes ✓
10. **zig build succeeds** — Compilation verified ✓
